# デプロイガイド - Discord Multi-Agent System

## 🚀 クイックスタート

### 前提条件
```bash
# システム要件
- Python 3.9+
- Redis 7.0+
- PostgreSQL 14+ with pgvector
- datasketch (pip install datasketch)
- 2GB+ RAM, 2+ CPU cores
```

### 1. 環境セットアップ
```bash
# クローンとセットアップ
cd project-009/
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. 設定
`.env`ファイルを作成:
```bash
# Discord Bot Tokens
DISCORD_RECEPTION_TOKEN=your_reception_token
DISCORD_SPECTRA_TOKEN=your_spectra_token
DISCORD_LYNQ_TOKEN=your_lynq_token
DISCORD_PAZ_TOKEN=your_paz_token

# AI Integration
GEMINI_API_KEY=your_gemini_api_key

# Database
REDIS_URL=redis://localhost:6379
POSTGRESQL_URL=postgresql://user:pass@localhost:5432/db

# Channel IDs
COMMAND_CENTER_CHANNEL_ID=YOUR_COMMAND_CENTER_CHANNEL_ID
LOUNGE_CHANNEL_ID=YOUR_LOUNGE_CHANNEL_ID
DEVELOPMENT_CHANNEL_ID=YOUR_DEVELOPMENT_CHANNEL_ID
CREATION_CHANNEL_ID=YOUR_CREATION_CHANNEL_ID

# System Configuration
ENVIRONMENT=production  # または test
LOG_LEVEL=INFO
HEALTH_CHECK_PORT=8000

# 環境別自発発言設定（v0.2.4対応）
# test: 10秒間隔, 100%確率（開発・検証用、LLM統合+テンプレートフォールバック）
# production: 300秒間隔, 33%確率（本番運用、LLM統合+テンプレートフォールバック）
# LLM統合: Gemini 2.0 Flash使用、エラー時はテンプレートフォールバック
```

### 2.1. 環境別設定詳細

#### **TEST環境（開発・検証用）**
```bash
ENVIRONMENT=test
```
- **自発発言**: 10秒間隔、100%確率
- **LLM統合**: Gemini 2.0 Flash使用、フォールバック併用
- **リアルトークン/API使用**: Discord・Gemini APIともに実際の値を使用
- **用途**: 機能検証、動作確認、LLM統合テスト
- **ログ**: より詳細なデバッグ情報表示

#### **PRODUCTION環境（本番運用）**
```bash
ENVIRONMENT=production
```
- **自発発言**: 300秒間隔（5分）、33%確率
- **LLM統合**: Gemini 2.0 Flash使用、安定したフォールバック保証
- **リアルトークン/API使用**: Discord・Gemini APIともに実際の値を使用
- **用途**: 本番運用、エンドユーザー向けサービス
- **ログ**: 必要最小限の運用ログ

**重要**: 両環境ともリアルなDiscordトークンとGemini APIキーを使用します。v0.2.4では LLM統合基盤が実装されており、エラー時は改善されたテンプレートシステムにフォールバックします。

### 3. システム開始
```bash
# ログ付きで開始
python main.py

# またはバックグラウンドプロセス
nohup python main.py > /dev/null 2>&1 &
```

## 🔧 システム運用

### ヘルス監視
```bash
# システムヘルスをチェック
curl http://localhost:8000/health

# メトリクスを表示
curl http://localhost:8000/metrics

# ログをチェック
tail -f logs/discord_agent.log
```

### システムコマンド
```bash
# 適切なシャットダウン
Ctrl+C  # または SIGTERM

# プロセスをチェック
ps aux | grep "python main.py"

# 必要に応じて強制終了
pkill -f "python main.py"
```

### タスク管理コマンド
```bash
# 新しいタスクを開始
/task commit development "認証システム実装"

# タスクまたはチャンネルを変更
/task change creation "アイデアブレスト"
```

## 🤖 **エージェント運用・個性設定**

### **エージェント特性・個性（v0.2.4改善版）**

#### **SPECTRA (スペクトラ)** - 統括ファシリテーター
- **役割**: メタ進行役、議論の構造化、全体方針整理、一般対話
- **個性**: 冷静だが積極的。物事を整理して前進させる
- **口調**: 女性的で親しみやすい「〜しよう」「〜してみる？」「〜だと思う」
- **改善点**: 絵文字プレフィックス削除、より自然な女性口調に調整
- **得意領域**: プロジェクト管理、会議進行、チーム調整

#### **LYNQ (リンク)** - 論理エンジニア
- **役割**: 論理収束役、技術的検証、構造化分析、問題解決
- **個性**: 端的で感情控えめ。論理的に分析し解決策を提示
- **口調**: 女性的だが論理的「〜を確認すると」「〜という構造」「〜が効率的」
- **改善点**: 技術的議論でも女性らしさを保持、堅すぎない表現に調整
- **得意領域**: 技術討論、システム分析、問題解決

#### **PAZ (パズ)** - 創造クリエイター
- **役割**: 発散創造役、革新的アイデア、創造的テーマ、ブレインストーミング
- **個性**: 冷静だが平和的。創造的で協調性重視
- **口調**: 親しみやすい女性口調「〜かもしれない」「〜してみない？」「〜だよね」
- **改善点**: より親しみやすく、クリエイティブな表現力を向上
- **得意領域**: アイデア発想、創作活動、ブレインストーミング

### **チャンネル特化運用**
- **command-center**: 全体議論、方針決定、プロジェクト管理（Spectra 40%、LynQ 30%、Paz 30%）
- **development**: 技術討論、開発タスク、システム分析（LynQ 50%、その他25%）
- **creation**: 創作活動、アイデア発想、ブレインストーミング（Paz 50%、その他25%）
- **lounge**: 雑談、交流、リラックスした会話（3者均等33%ずつ）

### **LLM統合エージェント選択（v0.2.4実装状況）**
- **技術基盤**: Gemini 2.0 Flash による文脈考慮エージェント選択（部分実装）
- **選択要因**: チャンネル特性、メッセージ内容、過去の文脈を総合判断
- **対応タイプ**: タスク遂行、議論促進、雑談交流、相談対応を状況に応じて実行
- **品質保証**: システムプロンプトによる一貫した個性・口調の維持
- **現在の状態**: LLM統合基盤実装済み、テンプレートフォールバック併用
- **自発発言**: 改善されたテンプレートシステム（絵文字削除、口調改善済み）

## 🧠 **長期記憶・日報システム運用**

### **長期記憶システム（06:00自動処理）**

#### **処理内容**
- **処理時間**: 毎日06:00自動実行
- **API使用量**: 3回/日（Gemini 2.0 Flash + text-embedding-004）
- **処理時間**: 約5-10分

#### **監視方法**
```bash
# 長期記憶処理ログ確認
grep "長期記憶" logs/discord_agent.log | tail -10

# PostgreSQL記憶データ確認
psql -d discord_agent_prod -c "SELECT COUNT(*) FROM unified_memories WHERE DATE(timestamp) = CURRENT_DATE;"

# API使用量確認
grep "API usage" logs/discord_agent.log | tail -5
```

#### **エラー対応**
```bash
# API制限エラーの場合
# → Gemini APIキーの確認、レート制限確認

# PostgreSQL接続エラーの場合
psql -h localhost -U discord_agent_prod -d discord_agent_prod -c "SELECT 1;"

# 重複検出エラーの場合
# → datasketch依存関係確認
pip list | grep datasketch
```

### **日報システム（イベントドリブン送信）**

#### **処理内容**
- **送信タイミング**: 長期記憶化完了次第自動送信
- **API使用量**: 0回（テンプレート式）
- **処理時間**: <30秒
- **後続処理**: 送信完了次第会議開始宣言

#### **監視方法**
```bash
# 日報送信ログ確認
grep "Daily Report" logs/discord_agent.log | tail -5

# 日報フォーマット確認例
# 📅 Daily Report - 2025-06-23
# 🧭 Command Center: [テーマ]: [詳細]
# 🗃️ Creation: [テーマ]: [詳細]
# 🗃️ Development: [テーマ]: [詳細]
```

#### **トラブルシューティング**
```bash
# 日報が送信されない場合
# → 原子的記憶データの確認
psql -d discord_agent_prod -c "SELECT COUNT(*) FROM unified_memories WHERE DATE(timestamp) = CURRENT_DATE;"

# フォーマットエラーの場合
# → entitiesフィールドの確認
psql -d discord_agent_prod -c "SELECT metadata->'entities' FROM unified_memories LIMIT 5;"

# Discord送信エラーの場合
# → Discordトークンとチャンネル権限確認
```

### **データ管理**

#### **定期メンテナンス（週次）**
```bash
# 古い記憶データのアーカイブ（30日以上）
psql -d discord_agent_prod -c "
DELETE FROM unified_memories 
WHERE timestamp < NOW() - INTERVAL '30 days';
"

# pgvectorインデックス再構築
psql -d discord_agent_prod -c "REINDEX INDEX idx_embedding;"

# データベース統計更新
psql -d discord_agent_prod -c "ANALYZE unified_memories;"
```

#### **バックアップ**
```bash
# 長期記憶データバックアップ
pg_dump discord_agent_prod -t unified_memories > backup_memories_$(date +%Y%m%d).sql

# Redisデータバックアップ
redis-cli BGSAVE
```

### **統合朝次ワークフロー監視**

#### **全体フロー確認**
```bash
# 06:00からの全ワークフロー確認
grep -E "(長期記憶|Daily Report|会議開始)" logs/discord_agent.log | tail -20

# 処理時間の分析
grep "06:00" logs/discord_agent.log | grep -E "(開始|完了)" | tail -10

# エラー検出
grep -E "(失敗|ERROR|延期)" logs/discord_agent.log | grep -A 5 -B 5 "06:00"
```

#### **ワークフロー成功パターン**
```bash
# 正常なログパターン例:
# 06:00:15 🧠 長期記憶化処理開始
# 06:08:32 ✅ 長期記憶化完了: 145件処理
# 06:08:45 📊 日報生成開始
# 06:09:12 ✅ 日報送信完了
# 06:09:15 🏛️ 会議開始宣言
```

#### **異常時対応**
```bash
# 長期記憶化が失敗した場合
# → 前日データで日報生成、会議は通常開始

# 日報生成が失敗した場合  
# → 会議開始延期、システムメンテナンス通知

# 部分的失敗の場合
# → 処理完了分で継続、エラー内容をログ記録
```

## 🗄️ データベースセットアップ

### Redisセットアップ
```bash
# Redisをインストール
sudo apt install redis-server

# Redisを開始
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 検証
redis-cli ping
```

### PostgreSQLセットアップ
```bash
# PostgreSQL + pgvectorをインストール
sudo apt install postgresql postgresql-contrib
sudo -u postgres psql

-- データベースとユーザーを作成
CREATE DATABASE discord_agent_prod;
CREATE USER discord_agent_prod WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE discord_agent_prod TO discord_agent_prod;

-- pgvector拡張をインストール
\c discord_agent_prod
CREATE EXTENSION vector;
```

## 🔍 トラブルシューティング

### よくある問題

#### **Discord接続失敗**
```bash
# .envでトークンをチェック
grep DISCORD .env

# ボット権限を確認
# - Read Messages
# - Send Messages  
# - Read Message History
```

#### **メモリシステムの問題**
```bash
# Redisをチェック
redis-cli ping

# PostgreSQLをチェック
psql -h localhost -U discord_agent_prod -d discord_agent_prod -c "SELECT 1;"

# 既知：PostgreSQL検索は一時無効化（v0.2.0）
```

#### **自発発言が動作しない**
```bash
# ログで発言イベントをチェック
grep "自発発言" logs/discord_agent.log

# 環境を確認
echo $ENVIRONMENT  # 'test' または 'production' であるべき

# テストモード: 10秒間隔、100%確率
# 本番モード: 5分間隔、33%確率
```

#### **タスクコマンドが失敗する**
```bash
# コマンド形式をチェック
/task commit development "task description"
/task change creation "new task"

# ログをチェック
grep "Task command" logs/discord_agent.log
```

### エラーパターン
```bash
# 重要エラーは表示されるべきではない
grep "ERROR\|❌" logs/discord_agent.log

# 許容される警告:
# - "PyNaCl is not installed" (音声は不要)
# - PostgreSQL接続エラー (cold memoryはv0.2.0で無効化)
```

## 📈 パフォーマンス監視

### 主要指標
- **応答時間**: <2秒であるべき
- **メモリ使用量**: 通常動作で約1.5GB
- **CPU使用率**: 低、メッセージ処理中にスパイク
- **ログファイルサイズ**: 通常動作で約500KB/日

### パフォーマンスコマンド
```bash
# システムリソース
htop
df -h
free -h

# アプリケーションパフォーマンス
curl http://localhost:8000/status

# ログ分析
grep "processed successfully" logs/discord_agent.log | tail -10
```

## 🔄 メンテナンス

### 日次運用
- エラーがないか`logs/discord_agent.log`を監視
- ヘルスエンドポイントをチェック: `curl localhost:8000/health`
- 自発発言が動作していることを確認

### 週次運用
- ディスク容量が気になる場合は古いログをアーカイブ
- システムパフォーマンス指標を確認
- 必要に応じて依存関係を更新

### 月次運用
- メモリクリーンアップのため完全システム再起動
- 古い会話データを確認・アーカイブ
- 必要に応じてドキュメントを更新

## 🚨 本番環境考慮事項

### セキュリティ
- トークンを絶対にリポジトリにコミットしない
- すべての秘密情報に環境変数を使用
- 本番環境でヘルスエンドポイントアクセスを制限
- 異常なAPI使用量を監視

### スケーリング
- 高可用性のためのRedisクラスター
- パフォーマンス向上のためのPostgreSQL読み取りレプリカ
- ロードバランシングでの複数インスタンス展開
- 大規模向けコンテナオーケストレーション（Docker/K8s）

### バックアップ
```bash
# Redisバックアップ
redis-cli BGSAVE

# PostgreSQLバックアップ
pg_dump discord_agent_prod > backup_$(date +%Y%m%d).sql
```

---

**システム状況とバージョンについては`CURRENT_STATUS.md`を参照**  
**テスト手順については`TESTING_GUIDE.md`を参照**