# システムアーキテクチャ - Discord Multi-Agent System

## 🏗️ アーキテクチャ概要

### システム構成（v0.2.4）
```
統合受信・個別送信型 + Clean Architecture + Fail-fast原則

┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Reception     │    │   LangGraph      │    │  Output Bots    │
│     Bot         │───▶│   Supervisor     │───▶│ Spectra/LynQ/Paz│
│  (統合受信)     │    │ (エージェント選択)│    │  (個別送信)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Priority      │    │   Memory         │    │    Discord      │
│    Queue        │    │   System         │    │   Channels      │
│  (Redis)        │    │ (Redis+PostgreSQL)│    │ (4チャンネル)   │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Clean Architecture 9層構造
```
src/
├── 🎯 application/     # アプリケーションサービス層
├── 🏛️ core/            # ビジネスロジック層
├── 🤖 agents/          # エージェント層
├── 💬 bots/            # Discordインターフェース層
├── 🔌 infrastructure/  # 外部サービス・永続化層
├── 🔧 container/       # 依存注入・DIコンテナ層
├── ⚙️ config/          # 設定管理層
└── 🛠️ utils/           # ユーティリティ層
```

## 🎯 システム要件

### 機能要件

#### FR-001: 統合メッセージ受信
- **要件**: 単一Reception Botが全Discordメッセージを受信
- **実装状態**: ✅ 完了
- **検証**: メッセージ受信率100%、重複処理なし

#### FR-002: 個別エージェント送信
- **要件**: 3エージェントが固有アイデンティティで送信
- **実装状態**: ✅ 完了
- **検証**: 個別Discord ID、@mention機能、オンライン状態

#### FR-003: LangGraph Supervisor統合
- **要件**: AI駆動エージェント選択システム
- **実装状態**: ✅ 完了
- **検証**: 決定100%LangGraph通過、>99%完了率

#### FR-004: 2層メモリシステム
- **要件**: Redis（ホット）+ PostgreSQL（コールド）
- **実装状態**: ⚠️ 部分実装
- **詳細**: Redis完了、PostgreSQL基盤完了・検索機能一時無効化

#### FR-005: タスク管理システム
- **要件**: `/task`コマンドによるクロスチャンネル管理
- **実装状態**: ✅ 完了
- **検証**: チャンネル移行、Redis履歴保存

#### FR-006: 自発発言システム
- **要件**: 環境別間隔での自動発言
- **実装状態**: ✅ 完了
- **設定**: test(10秒,100%), production(300秒,33%)

#### FR-007: 長期記憶システム（v0.3.0予定）
- **要件**: 3-API日次バッチ処理
- **実装状態**: 🚧 計画中
- **詳細**: 06:00自動実行、原子的記憶生成

### 非機能要件

#### NFR-001: パフォーマンス
- **応答時間**: <2秒必須（本番検証済み）
- **同時ユーザー**: 50+対応（負荷テスト済み）
- **メモリ使用量**: <1.5GB通常動作
- **API効率**: 統合処理による50%削減達成

#### NFR-002: 可用性
- **稼働率**: >99%目標
- **Fail-fast原則**: エラー時即座停止、隠蔽無し
- **戦略的フォールバック**: 6箇所でシステム継続性保証
- **エラー透明性**: 明確なエラー表示・ログ記録

#### NFR-003: 拡張性
- **Clean Architecture**: 9層構造による保守性
- **DI Container**: 依存関係の柔軟な管理
- **モジュール設計**: 各レイヤーの独立性確保

#### NFR-004: セキュリティ
- **認証**: Discord Bot Token認証
- **暗号化**: TLS通信、環境変数による秘密情報管理
- **監査**: 全API呼び出し・エラーのログ記録
- **制限**: API レート制限遵守（Embedding 15 RPM）

## 🤖 エージェントシステム

### エージェント特性・個性

#### SPECTRA（スペクトラ）🔵
- **役割**: 統括ファシリテーター、会議進行、プロジェクト管理
- **個性**: 冷静だが積極的、物事を整理して前進させる
- **口調**: 親しみやすい女性口調「〜しよう」「〜してみる？」「〜だと思う」
- **専門領域**: 全体方針整理、一般対話、チーム調整
- **チャンネル特化**: command-center（40%）、全チャンネル対応

#### LYNQ（リンク）🔴
- **役割**: 論理エンジニア、技術的検証、構造化分析
- **個性**: 端的で感情控えめ、論理的に分析し解決策を提示
- **口調**: 女性的だが論理重視「〜を確認すると」「〜という構造」「〜が効率的」
- **専門領域**: 技術討論、システム分析、問題解決
- **チャンネル特化**: development（50%）、技術系議論

#### PAZ（パズ）🟡
- **役割**: 創造クリエイター、革新的アイデア、ブレインストーミング
- **個性**: 冷静だが平和的、創造的で協調性重視
- **口調**: 親しみやすい女性口調「〜かもしれない」「〜してみない？」「〜だよね」
- **専門領域**: アイデア発想、創作活動、創造的テーマ
- **チャンネル特化**: creation（50%）、クリエイティブ活動

### エージェント選択システム
- **LLM統合**: Gemini 2.0 Flash による文脈考慮選択
- **統合処理**: 1回のAPI呼び出しで選択+応答生成
- **チャンネル適応**: 各チャンネルの特性に応じた選択重み
- **個性反映**: 口調・思考パターンの一貫性維持

## 💾 データアーキテクチャ

### 2層メモリシステム

#### Hot Memory（Redis）
- **目的**: 当日の高速アクセス用データ
- **保存期間**: 24時間
- **データ形式**: JSON形式の会話履歴、タスク状態
- **パフォーマンス**: <10ms アクセス時間

#### Cold Memory（PostgreSQL + pgvector）
- **目的**: 長期記憶・セマンティック検索
- **保存期間**: 永続（30日でアーカイブ）
- **データ形式**: 原子的記憶、embedding、メタデータ
- **検索**: ベクトル類似度検索（v0.3.0で有効化予定）

### データフロー
```
1. Discord Message → Reception Bot
2. Reception Bot → Priority Queue (Redis)
3. Priority Queue → LangGraph Supervisor
4. Supervisor → Memory System (読み込み)
5. Supervisor → Agent Selection & Response
6. Response → Output Bot → Discord
7. Conversation → Memory System (保存)
8. Daily 06:00 → Long-term Memory Processing (v0.3.0)
```

## 🔧 技術スタック

### コア技術
- **言語**: Python 3.9+
- **フレームワーク**: Discord.py, LangChain, LangGraph
- **AI**: Gemini 2.0 Flash API, text-embedding-004
- **データベース**: Redis 7.0+, PostgreSQL 14+ with pgvector
- **その他**: datasketch（重複検出）

### 外部サービス依存
- **Discord API**: ボット機能、メッセージ送受信
- **Gemini API**: LLM推論、embedding生成
- **Redis**: ホットメモリ、キューシステム
- **PostgreSQL**: コールドメモリ、永続化

### 開発・運用ツール
- **品質管理**: flake8, mypy, bandit, pytest
- **CI/CD**: GitHub Actions
- **監視**: ヘルスエンドポイント（ポート8000）
- **ログ**: 統合ログファイル（logs/discord_agent.log）

## 🔄 実装状況・ロードマップ

### v0.2.4（現在）実装状況 ✅
- **Fail-fast原則**: 36項目フォールバック削除、6箇所戦略的保持
- **Clean Architecture**: 9層構造リファクタリング完了
- **エージェント個性**: 3エージェントの個性・口調確立
- **基本機能**: Discord統合、タスク管理、自発発言すべて動作

### v0.3.0 実装計画 🚧
- **長期記憶システム**: 3-API バッチ処理（06:00実行）
- **日報システム**: API不要テンプレート式自動生成
- **PostgreSQL検索**: pgvector完全統合、セマンティック検索
- **フォールバック削除**: Phase 2残存1箇所削除

### v0.4.0 将来計画 📋
- **完全Fail-fast化**: 監視系フォールバック5箇所削除
- **スケーリング**: 100+同時ユーザー対応
- **高度AI統合**: マルチモーダル対応、コンテキスト理解強化
- **インフラ強化**: 冗長化、監視システム外部化

## 🚨 制約・注意事項

### 現在の制限事項（v0.2.4）
- **PostgreSQL検索**: 一時無効化（基盤準備完了、v0.3.0で復活）
- **API制限**: Embedding 15 RPM（本番運用制約）
- **フォールバック**: 戦略的6箇所保持（v0.4.0で削除予定）
- **長期記憶**: v0.3.0実装予定

### アーキテクチャ制約
- **Single Point of Failure**: Reception Bot（冗長化はv0.4.0予定）
- **API依存**: Gemini API障害時の影響
- **メモリ制約**: 1.5GB以内での動作要件
- **レート制限**: 各外部API制限への適応

### 設計判断
- **統合受信**: API効率とシンプルさ優先
- **Fail-fast**: エラー透明性と迅速な問題特定
- **Clean Architecture**: 保守性と拡張性の確保
- **戦略的フォールバック**: システム継続性との適切なバランス

## 📊 品質・監視

### 品質指標
- **テストカバレッジ**: 80%以上維持必須
- **応答時間**: <2秒平均（SLA）
- **エラー率**: <1%（月次）
- **API効率**: 50%削減達成済み

### 監視項目
- **システムヘルス**: localhost:8000/health
- **メトリクス**: localhost:8000/metrics
- **ログ監視**: logs/discord_agent.log
- **リソース使用量**: メモリ・CPU・ディスク

### アラート基準
- **応答時間**: >5秒で警告
- **メモリ使用量**: >2GBで警告
- **エラー率**: >5%で警告
- **API失敗**: 連続3回で警告

---

**運用・トラブルシューティングについては `docs/運用ガイド.md` を参照**  
**開発ワークフローについては `docs/開発ワークフロー.md` を参照**