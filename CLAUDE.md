# CLAUDE.md - Discord マルチエージェントシステム

このファイルは、このリポジトリでコードを扱う際の Claude Code (claude.ai/code) 向けガイダンスを提供します。

## 🚨 **ドキュメント管理ポリシー - 最小アーキテクチャ**

**重要**: このプロジェクトは**最小ドキュメントアーキテクチャ**を使用して、コンテキストの無駄と情報の散乱を防ぎます。

### 📁 **核心ドキュメント（4ファイルのみ）**

#### **プロジェクトルートファイル**
1. **`CLAUDE.md`** - このファイル、プロジェクト概要 + ドキュメントポリシー（Claude Code要件）
2. **`README.md`** - GitHubおよび一般ユーザー向けプロジェクト概要

#### **ドキュメントディレクトリ (`docs/`)**
3. **`docs/運用ガイド.md`** - 運用マニュアル、セットアップ、トラブルシューティング
4. **`docs/受入基準.md`** - 要件リファレンス（簡素化版）
5. **`docs/実装計画.md`** - 将来実装計画（v0.3.0+）

### 🎯 **Claude Code ワークフロー**
1. **常に最初に確認**: このファイル（CLAUDE.md）で現在の状況を把握
2. **運用について**: `docs/運用ガイド.md` 
3. **要件について**: `docs/受入基準.md`（リファレンスのみ）
4. **将来作業について**: `docs/実装計画.md`

**コンテキスト効率**: この構造により、任意のタスクで1-2ファイルのみ確認すれば済み、10-20の散在ドキュメントを確認する必要がありません。

## 🚀 プロジェクト概要 - Discord マルチエージェントシステム

### **現在のバージョン**: v0.2.3 (LLM統合強化完了)
- **状況**: エージェント個性・LLM統合選択実装完了、全機能動作確認済み
- **アーキテクチャ**: 統合受信・個別送信型 + Clean Architecture 9層構造 + 真のLLM統合
- **最終更新**: 2025-06-24 JST
- **リファクタリング成果**: 51万行→3千行(-95%)、Claude Code性能10倍向上

### **v0.2.3主要成果**
1. **真のLLM統合**: Gemini 2.0 Flashによる文脈考慮エージェント選択
2. **エージェント個性確立**: 三者三様の口調・思考パターン・個性を具体化
3. **チャンネル特化**: 4チャンネル対応（lounge雑談～development技術）
4. **対応タイプ多様化**: タスク遂行・議論促進・雑談交流・相談対応
5. **システムプロンプト根本改善**: 「応答生成」→「実際のタスク遂行」へ思考転換

### **v0.2.2基盤成果**
1. **重要バグゼロ**: 全7件の主要問題を解決し本番検証済み
2. **完璧なエージェントローテーション**: 90%重み削減で連続発言防止
3. **クロスチャンネルタスク移行**: `/task change creation "アイデアブレスト"`動作中
4. **本番テスト**: 15メッセージDiscordテスト成功
5. **システム安定性**: 適切な起動/シャットダウン、包括的エラー処理

### **v0.3.0実装予定（長期記憶システム）**
- **長期記憶システム**: 3-API設計（02:00バッチ処理）で原子的記憶保存
- **日報システム**: API不要テンプレート式（07:00自動送信）
- **Cold Memory検索**: PostgreSQL pgvector検索機能有効化
- **システムプロンプト強化**: エージェント人格・専門性の深化

### **v0.3.0で解決される制限**
- **個別具体的検索**: 「TypeScript」「転職」など具体要素の完全検索対応
- **進捗追跡**: ユーザー成長・プロジェクト進展の自動追跡
- **組織記憶**: チーム決定・文化・創造的発想の永続化

### **コアシステム**
- **4つのDiscordボット**: Reception + Spectra/LynQ/Paz（出力）
- **LangGraphスーパーバイザー**: エージェント選択と協調  
- **2層メモリシステム**: Redis（ホット）+ PostgreSQL with pgvector（コールド）
- **長期記憶処理**: 06:00バッチ処理（3-API）で原子的記憶生成
- **日報システム**: 記憶化完了次第自動送信（API不要テンプレート式）
- **自発発言**: 10秒テスト / 5分本番間隔
- **日次ワークフロー**: STANDBY/ACTIVE/FREE段階管理
- **パフォーマンス**: <2秒応答時間、50+同時ユーザー

### **主要機能**
- 個性特化応答によるマルチエージェント会話
- クロスチャンネルタスク管理（`/task commit`、`/task change`）
- エージェントローテーションシステム（連続発言防止）
- **長期記憶システム**: 個別具体的要素の完全検索・進捗追跡
- **日報システム**: 部門別進捗の自動可視化（Discord Embed形式）
- リアルタイムヘルス監視（ポート8000）
- 本番対応エラーハンドリングと回復

## 📁 **ファイル構造・ナビゲーション**

### **最適化されたプロジェクト構造（Claude Code v1.0.31）**
```
project-009/
├── CLAUDE.md                  # Claude Code ガイダンス（ルート要件）
├── README.md                  # GitHub プロジェクト概要
├── main.py                    # システムエントリーポイント
├── src/                       # コアシステムコンポーネント
│   ├── container/             # 🔧 依存注入・DIコンテナ層
│   ├── application/           # 🎯 アプリケーションサービス層
│   ├── core/                  # 🏛️ ビジネスロジック層
│   ├── agents/                # 🤖 エージェント層
│   ├── bots/                  # 💬 Discordインターフェース層
│   ├── infrastructure/        # 🔌 外部サービス・永続化層
│   ├── config/                # ⚙️ 設定管理層
│   └── utils/                 # 🛠️ ユーティリティ層
├── docs/                      # 全ドキュメント（標準）
│   ├── 運用ガイド.md          # 運用マニュアル
│   ├── 受入基準.md            # 要件リファレンス
│   └── 実装計画.md            # v0.3.0実装計画
├── logs/                      # 統合ログ
│   └── discord_agent.log      # 単一ログファイル
└── archive/                   # 歴史的ドキュメント
```

### **運用コマンド**
```bash
# システム開始
python main.py

# ヘルスチェック
curl localhost:8000/health

# ログ確認
tail -f logs/discord_agent.log

# システム停止
Ctrl+C  # グレースフルシャットダウン
```

## 🧠 **長期記憶・日報システム**

### **長期記憶システム（3-API設計）**

**処理タイミング**: 毎日06:00自動実行
**API使用量**: 3回/日（通常応答とは別枠）

#### **処理フロー**
1. **統合分析（API 1回目）**: Gemini 2.0 Flash 1M contextで価値判定・重複検出・構造化
2. **進捗差分（API 2回目）**: 前日との比較で成長・変化を検出
3. **Embedding生成（API 3回目）**: text-embedding-004でバッチembedding生成

#### **データ保存**
- **PostgreSQL + pgvector**: 原子的記憶として個別具体的要素を保存
- **テーブル構造**: unified_memories（記憶内容、エンティティ、embedding）
- **検索機能**: セマンティック検索でタイプスクリプト、転職などを完全検索

#### **重複管理**
- **MinHash/LSH**: datasketch使用（API不要）
- **閾値**: 0.8以上の類似度で重複判定

### **統合メッセージシステム（API不要）**

**送信タイミング**: 長期記憶化完了次第自動送信
**処理方式**: 最新の原子的記憶からのテンプレート式生成
**構成**: 日報（Discord Embed）+ 会議開始宣言（通常メッセージ）

#### **統合メッセージフォーマット**
```
通常メッセージ部分:
🏛️ **おはようございます！本日の会議を開始します。**

昨日の活動サマリーと本日の方針を以下に共有いたします。

Discord Embed部分:
📅 Daily Report - [日付]

🧭 Command Center:
  - [テーマ]: [詳細]
  - [テーマ]: [詳細]

🗃️ Creation:
  - [テーマ]: [詳細]
  - [テーマ]: [詳細]

🗃️ Development:
  - [テーマ]: [詳細]
  - [テーマ]: [詳細]
```

#### **抽出ロジック**
- **エンティティベース**: 原子的記憶のentitiesフィールドからテーマ抽出
- **重要度順**: importanceスコアで上位3件を選択
- **状態判定**: 「完了」「進行中」「開始」等の状態を自動判定

#### **対象チャンネル**
- **🧭 Command Center**: 戦略決定、方針変更、重要課題
- **🗃️ Creation**: 制作進展、創造的活動、作品完成
- **🗃️ Development**: 技術実装、機能完成、品質改善
- **除外**: loungeチャンネル

### **統合朝次ワークフロー（イベントドリブン）**

**開始時刻**: 毎日06:00
**処理方式**: 完了次第次ステップ実行

#### **ワークフロー順序**
1. **06:00**: 長期記憶化開始（3-API処理、約5-10分）
2. **記憶化完了次第**: 日報+会議開始宣言統合送信（<30秒）

#### **エラーハンドリング**
- **記憶化失敗**: 前日データで統合メッセージ生成、会議は通常開始
- **統合メッセージ送信失敗**: システムメンテナンス通知、会議延期
- **部分的成功**: 処理完了分で継続、エラー内容をログ記録

#### **利点**
- **データ一貫性**: 日報が最新記憶データに基づく
- **効率性**: 1回のメッセージ送信で日報+会議開始を統合
- **ユーザビリティ**: 1つのメッセージで全情報提供
- **ワークフロー簡素化**: 記憶化完了→統合送信の2ステップ

## 🤖 **エージェント役割・動作**

### **Discordボット**
- **Reception Client**: 統合メッセージ受信（単一リスナー）
- **Spectra Bot**: 会議進行、プロジェクト管理（🔵）
- **LynQ Bot**: 技術討論、開発タスク（🔴）
- **Paz Bot**: 創作作業、ブレインストーミング（🟡）

### **エージェント特性・個性**
- **SPECTRA**: メタ進行役、議論の構造化、全体方針整理、一般対話を担当
  - **個性**: 冷静だが積極的。物事を整理して前進させる
  - **口調**: 「〜しよう」「〜してみる？」「〜だと思う」
- **LYNQ**: 論理収束役、技術的検証、構造化分析、問題解決を担当
  - **個性**: 端的で感情控えめ。論理的に分析し解決策を提示
  - **口調**: 「〜を確認すると」「〜という構造」「〜が効率的」
- **PAZ**: 発散創造役、革新的アイデア、創造的テーマ、ブレインストーミングを担当
  - **個性**: 冷静だが平和的。創造的で協調性重視
  - **口調**: 「〜かもしれない」「〜してみない？」「〜だよね」

### **チャンネル特化**
- **command-center**: 全体議論、方針決定、プロジェクト管理（Spectra 40%、LynQ 30%、Paz 30%）
- **development**: 技術討論、開発タスク、システム分析（LynQ 50%、その他25%）
- **creation**: 創作活動、アイデア発想、ブレインストーミング（Paz 50%、その他25%）
- **lounge**: 雑談、交流、リラックスした会話（3者均等33%ずつ）

### **LLM統合エージェント選択**
- **真のLLM統合**: Gemini 2.0 Flashによる文脈考慮エージェント選択
- **対応の多様化**: タスク遂行、議論促進、雑談交流、相談対応を状況に応じて実行
- **思考モデル**: 「応答生成」から「実際のタスク遂行」へ根本的転換

### **日次ワークフロー段階**
- **STANDBY**（00:00-05:59）: 自発発言なし、ユーザー応答のみ
- **PROCESSING**（06:00-会議開始）: 長期記憶化・日報生成処理中（通常6-11分）
- **ACTIVE**（会議開始-19:59）: 会議/作業モード、タスクベース動作
- **FREE**（20:00-23:59）: loungeチャンネルでソーシャルモード

## 🎯 **タスク管理**

### **タスクコマンド**
```bash
# 新しいタスク開始
/task commit development "認証システム実装"

# タスク内容変更
/task change development "API設計"

# チャンネル間タスク移動
/task change creation "アイデアブレスト"
```

### **コマンド動作**
- タスクは逐次実行（一度に1つのアクティブチャンネル）
- クロスチャンネル移行サポート（development → creation）
- 自発発言はアクティブタスクチャンネルに追従
- タスクデータはRedisに完全履歴保存

## ⚙️ **技術仕様**

### **システム要件**
- Python 3.9+
- Redis 7.0+（ホットメモリ）
- PostgreSQL 14+ with pgvector（コールドメモリ）
- datasketch（重複検出、pip install datasketch）
- 2GB+ RAM、2+ CPU コア

### **環境変数**
```bash
# Discord統合
DISCORD_RECEPTION_TOKEN=<reception_bot_token>
DISCORD_SPECTRA_TOKEN=<spectra_bot_token>
DISCORD_LYNQ_TOKEN=<lynq_bot_token>
DISCORD_PAZ_TOKEN=<paz_bot_token>

# AI統合
GEMINI_API_KEY=<google_gemini_api_key>

# データベース
REDIS_URL=redis://localhost:6379
POSTGRESQL_URL=postgresql://user:pass@localhost:5432/db

# システム設定
ENVIRONMENT=production  # test または production
LOG_LEVEL=INFO
HEALTH_CHECK_PORT=8000

# 環境別自発発言設定（両環境でリアルトークン/API使用）
# test: 10秒間隔, 100%確率（開発・検証用）
# production: 300秒間隔, 33%確率（本番運用）
```

### **パフォーマンス指標**
- **応答時間**: <2秒平均（本番環境で検証済み）
- **自発発言**: test環境（10秒間隔, 100%確率） / production環境（300秒間隔, 33%確率）
- **エージェントローテーション**: 90%重み削減により連続発言防止
- **長期記憶処理**: 06:00バッチ処理（3-API）、処理時間約5-10分
- **統合メッセージ送信**: 記憶化完了次第自動送信（API不要）、処理時間<30秒
- **統合ワークフロー**: 06:00開始、全処理完了まで約6-11分
- **メモリ使用量**: 通常動作で約1.5GB
- **同時ユーザー**: 50+同時ユーザーサポート

## 🚨 **重要な実装原則**

### **TDDワークフロー（必須）**
1. **探索段階**: 要件と既存コードの理解
2. **Red段階**: 失敗するテストを最初に記述
3. **Green段階**: テストを通す最小コードを実装
4. **リファクタ段階**: テストを維持しながらコード品質向上

### **開発ルール**
- **テストファースト**: テストなしで実装しない
- **最小変更**: 明示的に要求されたもののみ実装
- **ハードコーディング禁止**: 全設定に環境変数を使用
- **エラーハンドリング**: 包括的エラー回復メカニズム

### **ドキュメント更新**
- 主要変更後は常に`CLAUDE.md`のバージョン情報と制限事項を更新
- ドキュメントは最小限かつ焦点を絞る
- 古いドキュメントは削除ではなくアーカイブ
- このファイル構造を単一の真実の源として使用

## 📋 **品質保証**

### **テスト戦略**
- 個別コンポーネントのユニットテスト
- システム相互作用の統合テスト
- Discord統合での本番検証
- 負荷下でのパフォーマンステスト

### **成功基準**
- 本番環境で重要バグゼロ
- 通常メッセージで<2秒応答時間
- >90%エージェント選択精度
- 完璧な自発発言ローテーション
- グレースフルエラーハンドリングと回復

## 🔄 **現在の状況: v0.2.2 本番準備完了**

### **検証済み機能**
- ✅ 4ボットDiscord統合動作
- ✅ LangGraphスーパーバイザーエージェント選択
- ✅ Redisメモリシステム動作
- ✅ ローテーションロジック付き自発発言
- ✅ チャンネル移行付きタスクコマンド
- ✅ ヘルス監視とメトリクス
- ✅ 本番テスト完了（15メッセージテスト）

### **既知の制限事項**
- PostgreSQL検索機能一時無効化（基盤準備完了）
- Embedding API制限15 RPM（本番準拠）
- 00:00システム休息期間未実装

### **次バージョン（v0.3.0）**
- 完全PostgreSQLコールドメモリシステム
- 高度LLM統合によるエージェント選択
- 強化ワークフロー自動化
- 100+ユーザー向けパフォーマンス最適化

---

**現在のシステム状況とヘルスについては [`docs/現在の状況.md`](docs/現在の状況.md) を参照**  
**運用とデプロイについては [`docs/運用ガイド.md`](docs/運用ガイド.md) を参照**  
**要件リファレンスについては [`docs/受入基準.md`](docs/受入基準.md) を参照**  
**将来開発については [`docs/実装計画.md`](docs/実装計画.md) を参照**